<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥ åª½åª½å°±é†«è¡Œç¨‹åˆ†å·¥(é›²ç«¯ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #4a90e2;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --border-color: #d1d8e0;
            --text-main: #2d3436;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 10px; padding-bottom: 100px; }
        .container { max-width: 500px; margin: 0 auto; }
        
        header { 
            text-align: center; padding: 15px; 
            background: linear-gradient(135deg, #4a90e2, #357abd); 
            color: white; border-radius: 12px; margin-bottom: 15px; 
        }
        
        #sync-status { font-size: 0.8rem; margin-top: 5px; opacity: 0.8; }

        .event-card { 
            background: var(--card-bg); border-radius: 12px; padding: 15px; 
            margin-bottom: 12px; border-left: 8px solid var(--warning-color); 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
        }
        .event-card.assigned { border-left-color: var(--success-color); }

        .date-badge { 
            display: inline-block; background: #edf2f7; color: var(--primary-color); 
            padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; 
        }
        .event-title { font-size: 1.15rem; font-weight: bold; margin: 8px 0; }
        .hint { font-size: 0.85rem; color: #e74c3c; margin-bottom: 10px; background: #fff5f5; padding: 5px 8px; border-radius: 4px; }

        .control-group { display: grid; grid-template-columns: 100px 1fr; gap: 8px; }
        select, input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; }

        .action-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 15px; box-shadow: 0 -3px 10px rgba(0,0,0,0.1); 
            display: flex; gap: 10px; max-width: 500px; margin: 0 auto; 
        }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: white; }
        .btn-copy { background: var(--success-color); }
        
        #loader { text-align: center; padding: 50px; color: var(--text-main); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ¥ åª½åª½å°±é†«è¡Œç¨‹åˆ†å·¥</h1>
        <div id="sync-status">ğŸ“¡ é›²ç«¯é€£ç·šä¸­...</div>
    </header>

    <div id="loader">è®€å–é›²ç«¯è³‡æ–™ä¸­...</div>
    <div id="event-list"></div>

    <div class="action-bar">
        <button class="btn-copy" id="copyBtn">ğŸ“‹ è¤‡è£½ LINE è¨Šæ¯</button>
    </div>
</div>

<script type="module">
    // --- 1. Firebase åˆå§‹åŒ– ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCFcgyPnDEtcFN4rZmdMW0LT0qhKhE3XhY",
        authDomain: "mom-medical.firebaseapp.com",
        databaseURL: "https://mom-medical-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mom-medical",
        storageBucket: "mom-medical.firebasestorage.app",
        messagingSenderId: "726908299188",
        appId: "1:726908299188:web:727944c84e246adef8b4e1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const scheduleRef = ref(db, 'schedule');

    // --- 2. è¡Œç¨‹è³‡æ–™æ›´æ–° ---
    const candidates = ["æœªèªé ˜", "æ´ªæ…§çœŸ", "æ´ªåœ‹é¾", "æ´ªæ…§ç´”", "æ´ªèŠ³èŒ¹", "æ´ªåœ‹å³°"];
    const events = [
        { id: 'ev1', date: '2026-02-20', weekday: 'äº”', time: 'æ—©ä¸Š', title: 'æŠ½è¡€ï¼‹é©—å°¿', location: 'é†«é™¢æª¢é©—ç§‘', notesHint: 'ç©ºè…¹ 8â€“12 å°æ™‚' },
        { id: 'ev2', date: '2026-02-21', weekday: 'å…­', time: 'ä¸Šåˆ', title: 'ç¥ç¶“ç§‘å›è¨º', location: 'è©¹å¼˜å»·é†«å¸«', notesHint: '' },
        { id: 'ev3', date: '2026-02-26', weekday: 'å››', time: '08:30', title: 'ç¥ç¶“å‚³å° NCV', location: 'æª¢æŸ¥å®¤', notesHint: '' },
        { id: 'ev4', date: '2026-02-26', weekday: 'å››', time: '10:00', title: 'è…¦æ³¢ EEG', location: '2æ¨“è…¦æ³¢å®¤', notesHint: 'å‰ä¸€å¤©æ´—é ­ã€ä¸è¦é«®æ²¹' },
        { id: 'ev5', date: '2026-03-03', weekday: 'äºŒ', time: '10:00', title: 'SSEP æª¢æŸ¥', location: 'æª¢æŸ¥å®¤', notesHint: '' },
        { id: 'ev7', date: '2026-03-10', weekday: 'äºŒ', time: 'ä¸Šåˆ', title: 'ç‰™é½’æª¢æŸ¥/æ²»ç™‚', location: 'ç‰™ç§‘è¨ºæ‰€', notesHint: '' },
        { id: 'ev6', date: '2026-03-23', weekday: 'ä¸€', time: '15:00', title: 'æ™ºèƒ½æª¢æŸ¥', location: 'æª¢æŸ¥å®¤', notesHint: '' },
        { id: 'ev8', date: '2026-03-31', weekday: 'äºŒ', time: 'ä¸Šåˆ', title: 'æ–°é™³ä»£è¬ç§‘å›è¨º', location: 'é†«é™¢', notesHint: '' }
    ];

    let currentData = {};

    // --- 3. æ ¸å¿ƒåŠŸèƒ½ï¼šç›£è½é›²ç«¯è®Šå‹• ---
    onValue(scheduleRef, (snapshot) => {
        currentData = snapshot.val() || {};
        document.getElementById('loader').style.display = 'none';
        document.getElementById('sync-status').innerText = 'âœ… é›²ç«¯åŒæ­¥ä¸­';
        render(currentData);
    });

    // --- 4. ç•«é¢æ¸²æŸ“ ---
    function render(data) {
        const list = document.getElementById('event-list');
        list.innerHTML = '';

        events.forEach(ev => {
            const state = data[ev.id] || { assignee: 'æœªèªé ˜', note: '' };
            const isAssigned = state.assignee !== 'æœªèªé ˜';
            
            const card = document.createElement('div');
            card.className = `event-card ${isAssigned ? 'assigned' : ''}`;
            
            card.innerHTML = `
                <div class="date-badge">${ev.date} (${ev.weekday}) ${ev.time}</div>
                <div class="event-title">${ev.title}</div>
                ${ev.notesHint ? `<div class="hint">âš ï¸ ${ev.notesHint}</div>` : ''}
                <div class="control-group">
                    <select data-id="${ev.id}" class="assignee-select">
                        ${candidates.map(c => `<option value="${c}" ${state.assignee === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    <input type="text" data-id="${ev.id}" class="note-input" placeholder="å‚™è¨»..." value="${state.note || ''}">
                </div>
            `;
            list.appendChild(card);
        });

        document.querySelectorAll('.assignee-select').forEach(el => {
            el.onchange = (e) => updateCloud(e.target.dataset.id, 'assignee', e.target.value);
        });
        document.querySelectorAll('.note-input').forEach(el => {
            el.onblur = (e) => updateCloud(e.target.dataset.id, 'note', e.target.value);
        });
    }

    function updateCloud(id, field, value) {
        if (!currentData[id]) currentData[id] = { assignee: 'æœªèªé ˜', note: '' };
        currentData[id][field] = value;
        document.getElementById('sync-status').innerText = 'â³ æ­£åœ¨å„²å­˜...';
        set(scheduleRef, currentData);
    }

    document.getElementById('copyBtn').onclick = () => {
        let text = `ã€ğŸ¥ åª½åª½å°±é†«è¡Œç¨‹åˆ†å·¥ã€‘\n\n`;
        events.forEach((ev, i) => {
            const state = currentData[ev.id] || { assignee: 'æœªèªé ˜', note: '' };
            text += `${i+1}. ${ev.date.slice(5)} (${ev.weekday}) ${ev.title}\n`;
            text += `   ğŸ™‹ è² è²¬ï¼š${state.assignee}\n`;
            if(state.note || ev.notesHint) {
                text += `   ğŸ“ å‚™è¨»ï¼š${[ev.notesHint, state.note].filter(x=>x).join('ã€')}\n`;
            }
            text += `\n`;
        });
        text += `æœ€æ–°é€²åº¦ï¼š${window.location.href.split('?')[0]}`;
        
        navigator.clipboard.writeText(text).then(() => {
            alert("å·²è¤‡è£½æ–‡å­—ï¼å¯ç›´æ¥è²¼åˆ° LINE ç¾¤çµ„ã€‚");
        });
    };
</script>

</body>
</html>